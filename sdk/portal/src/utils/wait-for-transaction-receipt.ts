import { createClient } from "graphql-ws";

/**
 * Represents the structure of a blockchain transaction with its receipt
 *
 * @typedef {Object} Transaction
 * @property {Object} receipt - The transaction receipt details
 * @property {string} receipt.transactionHash - The hash of the transaction
 * @property {string} receipt.to - The recipient address of the transaction
 * @property {string} receipt.status - The status of the transaction (success/failure)
 * @property {string} receipt.from - The sender address of the transaction
 * @property {string} receipt.type - The type of the transaction
 * @property {string} receipt.revertReason - The reason for transaction reversion, if applicable
 * @property {string} receipt.revertReasonDecoded - Human-readable version of the revert reason
 * @property {string} receipt.contractAddress - The address of the contract deployed in the transaction
 * @property {string[]} receipt.logs - Array of log entries generated by the transaction
 * @property {string[]} receipt.events - Array of events emitted during the transaction
 * @property {string} transactionHash - The hash of the transaction (duplicate of receipt.transactionHash)
 * @property {string} from - The sender address (duplicate of receipt.from)
 * @property {string} createdAt - Timestamp when the transaction was created
 * @property {string} address - The contract address involved in the transaction
 * @property {string} functionName - The name of the function called in the transaction
 * @property {boolean} isContract - Whether the transaction is a contract deployment
 */
export interface Transaction {
  receipt: {
    transactionHash: string;
    to: string;
    status: string;
    from: string;
    type: string;
    revertReason: string;
    revertReasonDecoded: string;
    logs: string[];
    events: string[];
    contractAddress: string;
  };
  transactionHash: string;
  from: string;
  createdAt: string;
  address: string;
  functionName: string;
  isContract: boolean;
}

interface GetTransactionResponse {
  getTransaction: Transaction;
}

/**
 * Options for waiting for a transaction receipt
 *
 * @typedef {Object} WaitForTransactionReceiptOptions
 * @property {string} portalGraphqlEndpoint - The GraphQL endpoint URL for the Portal API
 * @property {string} accessToken - The access token for authentication with the Portal API
 * @property {number} [timeout] - Optional timeout in milliseconds before the operation fails
 */
export interface WaitForTransactionReceiptOptions {
  portalGraphqlEndpoint: string;
  accessToken: string;
  timeout?: number;
}

/**
 * Wait for the transaction receipt
 * @param transactionHash transaction hash
 * @param options options
 * @returns receipt
 */
export async function waitForTransactionReceipt(transactionHash: string, options: WaitForTransactionReceiptOptions) {
  const wsClient = createClient({
    url: options.portalGraphqlEndpoint.toLowerCase().replace("/graphql", `/${options.accessToken}/graphql`),
  });
  const subscription = wsClient.iterate<GetTransactionResponse>({
    query: `subscription getTransaction($transactionHash: String!) {
        getTransaction(transactionHash: $transactionHash) {
          receipt {
            transactionHash
            to
            status
            from
            type
            revertReason
            revertReasonDecoded
            logs
            events
            contractAddress
          }
          transactionHash
          from
          createdAt
          address
          functionName
          isContract
        }
      }`,
    variables: { transactionHash },
  });
  return Promise.race([
    new Promise<undefined>((_resolve, reject) => {
      if (options.timeout) {
        setTimeout(() => {
          wsClient.dispose();
          reject(new Error("Transaction receipt not found"));
        }, options.timeout);
      }
    }),
    (async () => {
      for await (const result of subscription) {
        if (result?.data?.getTransaction?.receipt) {
          wsClient.dispose();
          return result.data.getTransaction;
        }
      }
    })(),
  ]);
}
