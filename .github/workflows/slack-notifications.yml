name: Slack Notifications

on:
  workflow_run:
    workflows: ["Build, test and publish"]
    types: [completed]
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  slack-notification:
    name: Send Slack Notification
    runs-on: namespace-profile-sdk
    if: |
      github.actor != 'dependabot[bot]' && github.actor != 'renovate[bot]' &&
      github.event_name == 'pull_request'
    steps:
      - name: Configure 1Password
        uses: 1password/load-secrets-action/configure@581a835fb51b8e7ec56b71cf2ffddd7e68bb25e0 # v2
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Load secrets
        uses: 1password/load-secrets-action@581a835fb51b8e7ec56b71cf2ffddd7e68bb25e0 # v2
        env:
          SLACK_BOT_TOKEN: op://platform/slack-bot/SLACK_BOT_TOKEN
          SLACK_CHANNEL_ID: op://platform/slack-bot/SLACK_CHANNEL_ID

      - name: Get build workflow status
        id: build_status
        if: github.event_name == 'workflow_run'
        run: |
          echo "build_result=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT

      - name: Check for existing Slack message
        id: check_message
        if: |
          github.event_name == 'pull_request' &&
          github.event.pull_request != null &&
          !github.event.pull_request.draft
        run: |
          # Check if there's an existing comment with Slack message timestamp
          COMMENT=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            | jq -r '.[] | select(.body | startswith("<!-- slack-ts:")) | .body' | head -1)

          if [ -n "$COMMENT" ]; then
            SLACK_TS=$(echo "$COMMENT" | sed -n 's/<!-- slack-ts:\(.*\) -->.*/\1/p')
            echo "slack_ts=$SLACK_TS" >> $GITHUB_OUTPUT
            echo "message_exists=true" >> $GITHUB_OUTPUT
          else
            echo "message_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Send or update Slack message
        id: slack_message
        if: |
          github.event_name == 'pull_request' &&
          github.event.pull_request != null &&
          !github.event.pull_request.draft
        uses: slackapi/slack-github-action@b0fa283ad8fea605de13dc3f449259339835fc52 # v2.1.0
        with:
          method: |
            ${{ steps.check_message.outputs.message_exists == 'true' &&
            'chat.update' || 'chat.postMessage' }}
          token: ${{ env.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ env.SLACK_CHANNEL_ID }}",
              ${{ steps.check_message.outputs.message_exists == 'true' && format('"ts": "{0}",', steps.check_message.outputs.slack_ts) || '' }}
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ github.event.pull_request.merged == true && 'ğŸ‰ Pull Request Merged' || (steps.check_message.outputs.message_exists == 'true' && 'ğŸ”„ Pull Request Updated') || 'ğŸ” New Pull Request Ready for Review' }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Title:*\n${{ github.event.pull_request.title }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\nğŸ‘¤ ${{ github.event.pull_request.user.login }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Reviewers:*\nğŸ‘¥ ${{ join(github.event.pull_request.requested_reviewers.*.login, ', ') }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*PR Status:*\n${{ github.event.pull_request.state == 'open' && 'ğŸŸ¢ Open' || (github.event.pull_request.merged == true && 'ğŸ‰ Merged') || 'ğŸ”´ Closed' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*QA Status:*\n${{ steps.build_status.outputs.build_result == 'success' && 'âœ… Passed' || steps.build_status.outputs.build_result == 'failure' && 'âŒ Failed' || steps.build_status.outputs.build_result == 'cancelled' && 'ğŸš« Cancelled' || steps.build_status.outputs.build_result == 'skipped' && 'â­ï¸ Skipped' || 'â³ Running' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Last Updated:*\nâ° ${{ github.event.pull_request.updated_at }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\nğŸ”— <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ“– View Pull Request"
                      },
                      "url": "${{ github.event.pull_request.html_url }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ“ View Files Changed"
                      },
                      "url": "${{ github.event.pull_request.html_url }}/files"
                    }
                  ]
                }
              ]
            }

      - name: Store Slack message timestamp
        if: |
          steps.slack_message.outcome == 'success' &&
          steps.check_message.outputs.message_exists == 'false' &&
          steps.slack_message.outputs.ts != ''
        run: |
          # Create a comment with the Slack message timestamp for future updates
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d "{\"body\": \"<!-- slack-ts:${{ steps.slack_message.outputs.ts }} -->\\nğŸ¤– Slack notification sent for this PR\"}"