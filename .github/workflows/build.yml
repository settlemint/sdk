name: Test

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: write
  checks: write
  contents: write
  deployments: write
  id-token: write
  issues: write
  discussions: write
  packages: write
  pages: write
  pull-requests: write
  repository-projects: write
  security-events: write
  statuses: write

jobs:
  packages:
    name: SDK packages
    runs-on: namespace-profile-sdk
    steps:
      - name: Checkout repository
        uses: namespacelabs/nscloud-checkout-action@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup caches
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: |
            ./.turbo
            ~/.bun/install/cache

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Bun dependencies
        run: bun install

      - name: Setup 1Password
        uses: settlemint/setup-op@main
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          version: 2.29.0

      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4

      - name: Update package versions
        id: package-version
        run: |
          OLD_VERSION=$(jq -r '.version' package.json)
          echo "Old version: $OLD_VERSION"
          if [[ $GITHUB_REF_SLUG =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION=$(echo $GITHUB_REF_SLUG | sed 's/^v//')
            echo "TAG=latest" >> $GITHUB_ENV
            echo "CONSOLE_GRAPHQL=https://console.settlemint.com/api/graphql" >> $GITHUB_ENV
          elif [[ $GITHUB_REF_NAME == "main" ]]; then
            VERSION="${OLD_VERSION}-main$(echo $GITHUB_SHA_SHORT | sed 's/^v//')"
            echo "TAG=main" >> $GITHUB_ENV
            echo "CONSOLE_GRAPHQL=https://console-release.settlemint.com/api/graphql" >> $GITHUB_ENV
          else
            VERSION="${OLD_VERSION}-pr$(echo $GITHUB_SHA_SHORT | sed 's/^v//')"
            echo "TAG=pr" >> $GITHUB_ENV
            echo "CONSOLE_GRAPHQL=https://console-release.settlemint.com/api/graphql" >> $GITHUB_ENV
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Updating version to $VERSION"
          jq --arg version "$VERSION" '.version = $version' package.json > package.json.tmp && mv package.json.tmp package.json

          update_package_json() {
            local dir="$1"
            local version="$2"
            echo "Updating $dir/package.json version to $version and updating workspace dependencies"
            jq --arg version "$version" '
              .version = $version |
              (.dependencies) |= with_entries(if .value == "workspace:*" then .value = $version else . end) |
              (.devDependencies) |= with_entries(if .value == "workspace:*" then .value = $version else . end) |
              (.peerDependencies) |= with_entries(if .value == "workspace:*" then .value = $version else . end)
            ' "$dir/package.json" > "$dir/package.json.tmp" && mv "$dir/package.json.tmp" "$dir/package.json" || {
              echo "Error updating $dir/package.json"
              cat "$dir/package.json.tmp"
              exit 1
            }
          }

          if [ -z "$VERSION" ]; then
            echo "Error: VERSION is not set"
            exit 1
          fi

          for dir in ./packages/*; do
            if [ -f "$dir/package.json" ]; then
              update_package_json "$dir" "$VERSION"
            fi
          done

          for dir in ./apps/*; do
            if [ -f "$dir/package.json" ]; then
              update_package_json "$dir" "$VERSION"
            fi
          done

          echo "Updated version to $VERSION"

      - name: Login to npm
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc

      - name: Run tests and checks
        run: bunx turbo format lint build attw publint registry test:coverage publish-npm --env-mode=loose
        env:
          SETTLEMINT_APPLICATION: ${{ secrets.SETTLEMINT_APPLICATION }}
          SETTLEMINT_HASURA: ${{ secrets.SETTLEMINT_HASURA }}
          SETTLEMINT_HD_PRIVATE_KEY: ${{ secrets.SETTLEMINT_HD_PRIVATE_KEY }}
          SETTLEMINT_INSTANCE: ${{ secrets.SETTLEMINT_INSTANCE }}
          SETTLEMINT_PORTAL: ${{ secrets.SETTLEMINT_PORTAL }}
          SETTLEMINT_THEGRAPH: ${{ secrets.SETTLEMINT_THEGRAPH }}
          SETTLEMINT_WORKSPACE: ${{ secrets.SETTLEMINT_WORKSPACE }}
          SETTLEMINT_AUTH_SECRET: ${{ secrets.SETTLEMINT_AUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          SETTLEMINT_IPFS: ${{ secrets.SETTLEMINT_IPFS }}
          SETTLEMINT_MINIO: ${{ secrets.SETTLEMINT_MINIO }}
          SETTLEMINT_ACCESS_TOKEN: ${{ secrets.SETTLEMINT_ACCESS_TOKEN }}

      - name: Make index
        run: |
          echo "Creating index.html with list of JSON files in apps/registry/public/"
          cd apps/registry/public
          echo "<html><head><title>Registry Files</title><script src='https://cdn.tailwindcss.com'></script></head><body class='bg-gray-100 dark:bg-gray-900'><div class='container mx-auto px-4 py-8 max-w-3xl'><h1 class='text-3xl font-bold mb-6 text-gray-800 dark:text-white border-b-2 border-blue-500 pb-2'>Registry Files</h1><ul class='space-y-4'>" > index.html
          for file in *.json; do
            echo "<li class='bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow duration-300'><span class='font-mono text-sm text-gray-600 dark:text-gray-400'>bunx shadcn@latest add</span> <a href='https://settlemint.github.io/sdk/$file' class='text-blue-600 dark:text-blue-400 hover:underline'>https://settlemint.github.io/sdk/$file</a></span></li>" >> index.html
          done
          echo "</ul></div><script>if (window.matchMedia('(prefers-color-scheme: dark)').matches) { document.documentElement.classList.add('dark') }</script></body></html>" >> index.html
          cd ../../..
          echo "Created index.html in apps/registry/public/"

      - name: Upload static files as artifact
        id: deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: apps/registry/public

      - name: Create or update PR comment
        if: ${{ github.event_name == 'pull_request' && matrix.pkg == 'cli' }}
        uses: taoliujun/action-unique-comment@v1
        with:
            uniqueIdentifier: ${{ github.workflow }}
            body: |
                # ðŸ“¦ Packages
                | Package | Version |
                | ------- | -------------------- |
                | SDK Cli | `@settlemint/sdk-cli@${{ env.VERSION }}` |
                | SDK The Graph | `@settlemint/sdk-thegraph@${{ env.VERSION }}` |
                | SDK Portal | `@settlemint/sdk-portal@${{ env.VERSION }}` |
                | SDK Hasura | `@settlemint/sdk-hasura@${{ env.VERSION }}` |
                | SDK JS | `@settlemint/sdk-js@${{ env.VERSION }}` |
                | SDK Utils | `@settlemint/sdk-utils@${{ env.VERSION }}` |
                | SDK Next | `@settlemint/sdk-next@${{ env.VERSION }}` |
                | SDK Minio | `@settlemint/sdk-minio@${{ env.VERSION }}` |
                | SDK IPFS | `@settlemint/sdk-ipfs@${{ env.VERSION }}` |

      - name: Auto-commit updated package versions
        uses: stefanzweifel/git-auto-commit-action@v5
        if: ${{ env.TAG == 'latest' }}
        with:
          commit_message: "chore: update package versions [skip ci]"
          branch: main
          file_pattern: 'package.json **/schema.graphql'

  docker:
    name: Build docker container
    runs-on: namespace-profile-sdk
    needs:
      - packages
    steps:
      - name: Checkout repository
        uses: namespacelabs/nscloud-checkout-action@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup caches
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: |
            ./.turbo
            ~/.bun/install/cache

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4

      - name: Update package versions
        id: package-version
        run: |
          OLD_VERSION=$(jq -r '.version' package.json)
          echo "Old version: $OLD_VERSION"
          if [[ $GITHUB_REF_SLUG =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION=$(echo $GITHUB_REF_SLUG | sed 's/^v//')
            echo "TAG=latest" >> $GITHUB_ENV
            echo "CONSOLE_GRAPHQL=https://console.settlemint.com/api/graphql" >> $GITHUB_ENV
          elif [[ $GITHUB_REF_NAME == "main" ]]; then
            VERSION="${OLD_VERSION}-main$(echo $GITHUB_SHA_SHORT | sed 's/^v//')"
            echo "TAG=main" >> $GITHUB_ENV
            echo "CONSOLE_GRAPHQL=https://console-release.settlemint.com/api/graphql" >> $GITHUB_ENV
          else
            VERSION="${OLD_VERSION}-pr$(echo $GITHUB_SHA_SHORT | sed 's/^v//')"
            echo "TAG=pr" >> $GITHUB_ENV
            echo "CONSOLE_GRAPHQL=https://console-release.settlemint.com/api/graphql" >> $GITHUB_ENV
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Updating version to $VERSION"
          jq --arg version "$VERSION" '.version = $version' package.json > package.json.tmp && mv package.json.tmp package.json

          update_package_json() {
            local dir="$1"
            local version="$2"
            echo "Updating $dir/package.json version to $version and updating workspace dependencies"
            jq --arg version "$version" '
              .version = $version |
              (.dependencies) |= with_entries(if .value == "workspace:*" then .value = $version else . end) |
              (.devDependencies) |= with_entries(if .value == "workspace:*" then .value = $version else . end) |
              (.peerDependencies) |= with_entries(if .value == "workspace:*" then .value = $version else . end)
            ' "$dir/package.json" > "$dir/package.json.tmp" && mv "$dir/package.json.tmp" "$dir/package.json" || {
              echo "Error updating $dir/package.json"
              cat "$dir/package.json.tmp"
              exit 1
            }
          }

          if [ -z "$VERSION" ]; then
            echo "Error: VERSION is not set"
            exit 1
          fi

          for dir in ./packages/*; do
            if [ -f "$dir/package.json" ]; then
              update_package_json "$dir" "$VERSION"
            fi
          done

          for dir in ./apps/*; do
            if [ -f "$dir/package.json" ]; then
              update_package_json "$dir" "$VERSION"
            fi
          done

          echo "Updated version to $VERSION"

      - name: Check if packages are published
        run: |
          echo "Checking if packages are published..."
          MAX_ATTEMPTS=60
          DELAY=10
          ATTEMPT=1

          check_package() {
            local package=$1
            local version=$2
            echo "Checking $package@$version..."
            if npm view "$package@$version" version &>/dev/null; then
              echo "$package@$version is published."
              return 0
            else
              echo "$package@$version is not yet published."
              return 1
            fi
          }

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            ALL_PUBLISHED=true

            for dir in ./packages/*; do
              if [ -f "$dir/package.json" ]; then
                PACKAGE_NAME=$(jq -r .name "$dir/package.json")
                PACKAGE_VERSION=$(jq -r .version "$dir/package.json")

                if ! check_package "$PACKAGE_NAME" "$PACKAGE_VERSION"; then
                  ALL_PUBLISHED=false
                  break
                fi
              fi
            done

            if $ALL_PUBLISHED; then
              echo "All packages are published."
              break
            fi

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "Timeout: Not all packages were published within the expected time."
              exit 1
            fi

            echo "Waiting for 10 seconds before next check (Attempt $ATTEMPT/$MAX_ATTEMPTS)..."
            sleep $DELAY
            ATTEMPT=$((ATTEMPT + 1))
          done

      - name: Run connect and codegen
        run: bunx turbo build registry:connect registry:codegen --env-mode=loose
        env:
          SETTLEMINT_APPLICATION: ${{ secrets.SETTLEMINT_APPLICATION }}
          SETTLEMINT_HASURA: ${{ secrets.SETTLEMINT_HASURA }}
          SETTLEMINT_HD_PRIVATE_KEY: ${{ secrets.SETTLEMINT_HD_PRIVATE_KEY }}
          SETTLEMINT_INSTANCE: ${{ secrets.SETTLEMINT_INSTANCE }}
          SETTLEMINT_PORTAL: ${{ secrets.SETTLEMINT_PORTAL }}
          SETTLEMINT_THEGRAPH: ${{ secrets.SETTLEMINT_THEGRAPH }}
          SETTLEMINT_WORKSPACE: ${{ secrets.SETTLEMINT_WORKSPACE }}
          SETTLEMINT_AUTH_SECRET: ${{ secrets.SETTLEMINT_AUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          SETTLEMINT_IPFS: ${{ secrets.SETTLEMINT_IPFS }}
          SETTLEMINT_MINIO: ${{ secrets.SETTLEMINT_MINIO }}
          SETTLEMINT_ACCESS_TOKEN: ${{ secrets.SETTLEMINT_ACCESS_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_PASS }}

      - name: Generate Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/settlemint/btp-registry
          tags: |
            type=raw,value=${{ env.TAG }}
            type=raw,value=${{ env.VERSION }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./apps/registry
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          provenance: mode=max
          sbom: true

  deploy:
    if: ${{ github.event_name != 'pull_request' && !startsWith(github.ref, 'refs/tags/') }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs:
      - packages
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

