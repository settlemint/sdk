name: Test

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  actions: write
  checks: write
  contents: write
  deployments: write
  id-token: write
  issues: write
  discussions: write
  packages: write
  pages: write
  pull-requests: write
  repository-projects: write
  security-events: write
  statuses: write

env:
  SETTLEMINT_PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

jobs:
  test:
    name: Test and Build
    runs-on: namespace-profile-sdk
    steps:
      - name: Checkout
        uses: namespacelabs/nscloud-checkout-action@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup caches
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: |
            ./node_modules
            ./.turbo
            ./packages/**/node_modules
            ./packages/**/.turbo
            ./packages/**/dist
            ~/.bun/install/cache

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          token: ${{ secrets.GITHUB_TOKEN }}

      - run: bun install

      - run: bunx turbo format lint pkg:build pkg:attw pkg:publint pkg:test:coverage

      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v4

      - name: Package version
        id: package-version
        run: |
          OLD_VERSION=$(jq -r '.version' package.json)
          echo "Old version: $OLD_VERSION"
          if [[ $GITHUB_REF_SLUG =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION=$(echo $GITHUB_REF_SLUG | sed 's/^v//')
            echo "TAG=latest" >> $GITHUB_ENV
          elif [[ $GITHUB_REF_NAME == "main" ]]; then
            VERSION="${OLD_VERSION}-main$(echo $GITHUB_SHA_SHORT | sed 's/^v//')"
            echo "TAG=main" >> $GITHUB_ENV
          else
            VERSION="${OLD_VERSION}-pr$(echo $GITHUB_SHA_SHORT | sed 's/^v//')"
            echo "TAG=pr" >> $GITHUB_ENV
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Updating version to $VERSION"
          jq --arg version "$VERSION" '.version = $version' package.json > package.json.tmp && mv package.json.tmp package.json

          update_package_json() {
            local dir="$1"
            local version="$2"
            echo "Updating $dir/package.json version to $version and updating workspace dependencies"
            jq --arg version "$version" '
              .version = $version |
              (.dependencies) |= with_entries(if .value == "workspace:*" then .value = $version else . end) |
              (.devDependencies) |= with_entries(if .value == "workspace:*" then .value = $version else . end) |
              (.peerDependencies) |= with_entries(if .value == "workspace:*" then .value = $version else . end)
            ' "$dir/package.json" > "$dir/package.json.tmp" && mv "$dir/package.json.tmp" "$dir/package.json" || {
              echo "Error updating $dir/package.json"
              cat "$dir/package.json.tmp"
              exit 1
            }
          }

          if [ -z "$VERSION" ]; then
            echo "Error: VERSION is not set"
            exit 1
          fi

          for dir in ./packages/*; do
            if [ -f "$dir/package.json" ]; then
              update_package_json "$dir" "$VERSION"
            fi
          done

          for dir in ./packages/sdk/templates/*; do
            if [ -f "$dir/package.json" ]; then
              update_package_json "$dir" "$VERSION"
            fi
          done

          echo "Updated version to $VERSION"

      - uses: JS-DevTools/npm-publish@v3
        with:
          token: ${{ secrets.NPM_TOKEN }}
          package: ./packages/sdk/package.json
          access: public
          provenance: false
          strategy: all
          tag: ${{ env.TAG }}

      - uses: JS-DevTools/npm-publish@v3
        with:
          token: ${{ secrets.NPM_TOKEN }}
          package: ./packages/next/package.json
          access: public
          provenance: false
          strategy: all
          tag: ${{ env.TAG }}

      - uses: JS-DevTools/npm-publish@v3
        with:
          token: ${{ secrets.NPM_TOKEN }}
          package: ./packages/react/package.json
          access: public
          provenance: false
          strategy: all
          tag: ${{ env.TAG }}

      - name: Create or update a comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: taoliujun/action-unique-comment@v1
        with:
            uniqueIdentifier: ${{ github.workflow }}
            body: |
                # ðŸ“¦ Packages
                | Package | Install |
                | ------- | -------------------- |
                | React | `bun add @settlemint/sdk-react@${{ env.VERSION }}` |
                | Next | `bun add @settlemint/sdk-next@${{ env.VERSION }}` |
                | SDK | `bun add @settlemint/sdk@${{ env.VERSION }}` |

      - uses: stefanzweifel/git-auto-commit-action@v5
        if: ${{ env.TAG == 'latest' }}
        with:
          commit_message: "chore: update package versions [skip ci]"
          branch: main
          file_pattern: 'package.json'


      # - name: Run scaffold test next-app-router
      #   run: |
      #     sleep 5s
      #     bunx @settlemint/sdk@${{ env.VERSION }} create -n test-next-app-router -t next-app-router -p bun

      #     cd test-next-app-router

      #     bunx settlemint connect -p ${{ secrets.TEST_PAT_TOKEN }} -i https://console.settlemint.com -w settlemint-product-strategy-f4e9 -a reference-sdk-app-7313 -da reference-sdk-app-7313 -pr https://reference-portal-a3f2.gke-europe.settlemint.com/api -pg https://reference-portal-a3f2.gke-europe.settlemint.com/graphql -tg https://reference-middleware-b1b9.gke-europe.settlemint.com/subgraphs/name/reference-erc20-0013 -h https://reference-hasura-e60f.gke-europe.settlemint.com/v1/graphql -n https://reference-read-node-1-56ab.gke-europe.settlemint.com/ -au http://localhost:3000

      #     bunx settlemint codegen

      #     bun run build

      # - name: Run scaffold test next-pages-router
      #   run: |
      #     sleep 5s
      #     bunx @settlemint/sdk@${{ env.VERSION }} create -n test-next-pages-router -t next-pages-router -p bun

      #     cd test-next-pages-router

      #     bunx settlemint connect -p ${{ secrets.TEST_PAT_TOKEN }} -i https://console.settlemint.com -w settlemint-product-strategy-f4e9 -a reference-sdk-app-7313 -da reference-sdk-app-7313 -pr https://reference-portal-a3f2.gke-europe.settlemint.com/api -pg https://reference-portal-a3f2.gke-europe.settlemint.com/graphql -tg https://reference-middleware-b1b9.gke-europe.settlemint.com/subgraphs/name/reference-erc20-0013 -h https://reference-hasura-e60f.gke-europe.settlemint.com/v1/graphql -n https://reference-read-node-1-56ab.gke-europe.settlemint.com/ -au http://localhost:3000

      #     bunx settlemint codegen

      #     bun run build